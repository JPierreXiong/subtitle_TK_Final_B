# çˆ†æ¬¾æ–‡æ¡ˆæ”¹å†™åŠŸèƒ½è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

åœ¨ç°æœ‰çš„"æå– â†’ ç¿»è¯‘"æµç¨‹åŸºç¡€ä¸Šï¼Œå¢åŠ **"æ”¹å†™"**åŠŸèƒ½ï¼Œè®©ç”¨æˆ·å¯ä»¥å°†æå–çš„å­—å¹•æŒ‰ç…§çˆ†æ¬¾æ¨¡æ¿æˆ–è‡ªå®šä¹‰éœ€æ±‚è¿›è¡Œæ”¹å†™ï¼Œæå‡æ–‡æ¡ˆè´¨é‡å’Œå¸å¼•åŠ›ã€‚

---

## ğŸ¯ ä¸€ã€åŠŸèƒ½éœ€æ±‚åˆ†æ

### 1.1 æ ¸å¿ƒåŠŸèƒ½

1. **çˆ†æ¬¾æ¨¡æ¿æ”¹å†™**
   - TikTok çˆ†æ¬¾æ¨¡å¼ï¼ˆå‰3ç§’é»„é‡‘é’©å­ã€å¼ºèŠ‚å¥æ„Ÿã€é«˜é¢‘æƒ…ç»ªè¯ï¼‰
   - YouTube æ·±åº¦æ¨¡å¼ï¼ˆç»“æ„åŒ–å†…å®¹ã€é•¿çº¿é€»è¾‘ã€å¹²è´§å¯†åº¦å¤§ï¼‰
   - å°çº¢ä¹¦é£æ ¼ï¼ˆç§è‰æ–‡æ¡ˆã€emoji ä¸°å¯Œã€äº’åŠ¨æ€§å¼ºï¼‰
   - å¾®åšé£æ ¼ï¼ˆçƒ­ç‚¹ç»“åˆã€è¯é¢˜æ€§å¼ºï¼‰

2. **è‡ªå®šä¹‰éœ€æ±‚æ”¹å†™**
   - ç”¨æˆ·è¾“å…¥æ¡†ï¼šå…è®¸ç”¨æˆ·è¾“å…¥ç‰¹å®šæ”¹å†™è¦æ±‚
   - å¿«æ·æ ‡ç­¾ï¼šæä¾›å¸¸ç”¨éœ€æ±‚å¿«é€Ÿé€‰æ‹©
   - æ··åˆæ¨¡å¼ï¼šæ¨¡æ¿ + è‡ªå®šä¹‰éœ€æ±‚

3. **æ”¹å†™ç»“æœç®¡ç†**
   - ä¿å­˜æ”¹å†™åçš„æ–‡æ¡ˆ
   - æ”¯æŒå¤šæ¬¡æ”¹å†™ï¼ˆA/B æµ‹è¯•ï¼‰
   - å¯¹æ¯”åŸæ–‡å’Œæ”¹å†™ç‰ˆ

### 1.2 ç”¨æˆ·åœºæ™¯

**åœºæ™¯ 1ï¼šæå–åç›´æ¥æ”¹å†™**
- ç”¨æˆ·æå– TikTok è§†é¢‘å­—å¹•
- é€‰æ‹©"TikTok çˆ†æ¬¾æ¨¡å¼"æ”¹å†™
- è·å¾—ä¼˜åŒ–åçš„çˆ†æ¬¾æ–‡æ¡ˆ

**åœºæ™¯ 2ï¼šè‡ªå®šä¹‰éœ€æ±‚æ”¹å†™**
- ç”¨æˆ·æå– YouTube è§†é¢‘å­—å¹•
- è¾“å…¥ï¼š"è¯·æŠŠè¿™æ®µæ–‡æ¡ˆæ”¹æˆè„±å£ç§€é£æ ¼ï¼ŒåŠ å…¥æ›´å¤šåæ§½ï¼Œé’ˆå¯¹ 20 å²å·¦å³çš„å¹´è½»äºº"
- è·å¾—å®šåˆ¶åŒ–æ”¹å†™ç»“æœ

**åœºæ™¯ 3ï¼šæ”¹å†™åç¿»è¯‘**
- ç”¨æˆ·æå–å­—å¹• â†’ æ”¹å†™ â†’ ç¿»è¯‘æˆç›®æ ‡è¯­è¨€
- æµç¨‹ï¼šæå– â†’ æ”¹å†™ â†’ ç¿»è¯‘

---

## ğŸ¨ äºŒã€UI è®¾è®¡æ–¹æ¡ˆ

### 2.1 æ•´ä½“å¸ƒå±€

åœ¨ `MediaExtractor` ç»„ä»¶ä¸­ï¼Œåœ¨"ç¿»è¯‘"åŠŸèƒ½åŒºåŸŸä¸‹æ–¹ï¼Œæ–°å¢"æ”¹å†™"åŠŸèƒ½åŒºåŸŸã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  URL è¾“å…¥æ¡†                          â”‚
â”‚  [æå–æŒ‰é’®]                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æå–ç»“æœå±•ç¤º                        â”‚
â”‚  - è§†é¢‘ä¿¡æ¯                          â”‚
â”‚  - å­—å¹•é¢„è§ˆ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ã€æ”¹å†™åŠŸèƒ½åŒºåŸŸã€‘ï¼ˆæ–°å¢ï¼‰            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ”¹å†™é£æ ¼é€‰æ‹©å™¨                  â”‚ â”‚
â”‚  â”‚ [TikTok] [YouTube] [å°çº¢ä¹¦]... â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ è‡ªå®šä¹‰éœ€æ±‚è¾“å…¥æ¡†ï¼ˆç´«è‰²å‘¼å¸ç¯ï¼‰ â”‚ â”‚
â”‚  â”‚ [è¾“å…¥ä½ çš„ç‰¹å®šæ”¹å†™è¦æ±‚...]      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  [å¿«æ·æ ‡ç­¾: æ›´å¹½é»˜/ç¼©çŸ­/ä¸“ä¸š/...]   â”‚
â”‚  [å¼€å§‹æ”¹å†™] æŒ‰é’®                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ã€ç¿»è¯‘åŠŸèƒ½åŒºåŸŸã€‘ï¼ˆç°æœ‰ï¼‰            â”‚
â”‚  [è¯­è¨€é€‰æ‹©å™¨] [å¼€å§‹ç¿»è¯‘]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ”¹å†™åŠŸèƒ½åŒºåŸŸè¯¦ç»†è®¾è®¡

#### A. é£æ ¼é€‰æ‹©å™¨

```tsx
<div className="space-y-3">
  <Label>æ”¹å†™é£æ ¼</Label>
  <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
    {REWRITE_STYLES.map((style) => (
      <Button
        key={style.value}
        variant={selectedStyle === style.value ? "default" : "outline"}
        onClick={() => setSelectedStyle(style.value)}
        className="h-auto py-3 flex flex-col items-center gap-1"
      >
        <style.icon className="h-5 w-5" />
        <span className="text-xs">{style.label}</span>
      </Button>
    ))}
  </div>
</div>
```

**é£æ ¼é€‰é¡¹**ï¼š
- `tiktok` - TikTok çˆ†æ¬¾æ¨¡å¼
- `youtube` - YouTube æ·±åº¦æ¨¡å¼
- `xiaohongshu` - å°çº¢ä¹¦é£æ ¼
- `weibo` - å¾®åšé£æ ¼
- `custom` - ä»…è‡ªå®šä¹‰ï¼ˆä¸ä½¿ç”¨æ¨¡æ¿ï¼‰

#### B. è‡ªå®šä¹‰éœ€æ±‚è¾“å…¥æ¡†ï¼ˆç´«è‰²å‘¼å¸ç¯æ•ˆæœï¼‰

```tsx
<div className="relative group">
  {/* å‘¼å¸ç¯èƒŒæ™¯å±‚ */}
  <div className="absolute -inset-0.5 bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl blur opacity-20 group-hover:opacity-40 transition duration-1000 group-focus-within:animate-pulse" />
  
  {/* è¾“å…¥æ¡† */}
  <textarea
    value={userRequirement}
    onChange={(e) => setUserRequirement(e.target.value)}
    placeholder="è¾“å…¥ä½ çš„ç‰¹å®šæ”¹å†™è¦æ±‚ï¼ŒGemini å°†ä¸ºæ‚¨æ·±åº¦å®šåˆ¶...&#10;ä¾‹å¦‚ï¼šæ”¹æˆå¹½é»˜åæ§½é£ / å¢åŠ æ›´å¤š Emoji / ç¼©çŸ­ç¯‡å¹…"
    className="relative w-full min-h-[100px] bg-black/60 backdrop-blur-xl border border-white/10 rounded-xl p-4 text-sm text-purple-50 placeholder:text-white/20 focus:outline-none focus:ring-2 focus:ring-purple-500/50 transition-all resize-none"
  />
  
  {/* å³ä¸‹è§’çŠ¶æ€æŒ‡ç¤ºå™¨ */}
  <div className="absolute bottom-3 right-3 flex items-center gap-2">
    {userRequirement.length > 0 && (
      <button 
        onClick={() => setUserRequirement('')}
        className="text-[10px] text-white/40 hover:text-white/80 transition-colors bg-white/5 px-2 py-1 rounded-md"
      >
        é‡ç½®
      </button>
    )}
    <div className={`w-1.5 h-1.5 rounded-full ${userRequirement ? 'bg-purple-500 animate-ping' : 'bg-white/10'}`} />
  </div>
</div>
```

#### C. å¿«æ·éœ€æ±‚æ ‡ç­¾

```tsx
<div className="flex flex-wrap gap-2">
  {QUICK_REQUIREMENTS.map((req) => (
    <button
      key={req}
      onClick={() => setUserRequirement(req)}
      className="text-xs px-3 py-1.5 rounded-md border border-white/5 bg-white/5 text-white/40 hover:bg-purple-500/20 hover:text-purple-300 hover:border-purple-500/30 transition-all"
    >
      + {req}
    </button>
  ))}
</div>
```

**å¿«æ·éœ€æ±‚**ï¼š
- "æ›´å¹½é»˜ä¸€ç‚¹"
- "ç¼©çŸ­ç¯‡å¹…"
- "å¢åŠ ä¸“ä¸šæ„Ÿ"
- "åŠ å…¥æ›´å¤š Emoji"
- "æ”¹æˆå£è¯­åŒ–"
- "å¢åŠ äº’åŠ¨å¼•å¯¼"

#### D. æ”¹å†™æŒ‰é’®

```tsx
<Button
  onClick={handleRewrite}
  disabled={!canRewrite || isRewriting}
  className="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700"
  size="lg"
>
  {isRewriting ? (
    <>
      <Loader2 className="mr-2 h-4 w-4 animate-spin" />
      AI æ­£åœ¨æ”¹å†™ä¸­...
    </>
  ) : (
    <>
      <Sparkles className="mr-2 h-4 w-4" />
      {userRequirement ? 'æŒ‰è¦æ±‚æ”¹å†™' : 'å¼€å§‹æ”¹å†™'}
    </>
  )}
</Button>
```

### 2.3 æ”¹å†™ç»“æœå±•ç¤º

#### A. æ”¹å†™ç»“æœå¡ç‰‡

```tsx
{rewrittenContent && (
  <Card className="border-purple-500/20 bg-gradient-to-br from-purple-950/20 to-blue-950/20">
    <CardHeader>
      <CardTitle className="flex items-center gap-2">
        <Sparkles className="h-5 w-5 text-purple-400" />
        AI æ”¹å†™ç»“æœ
      </CardTitle>
    </CardHeader>
    <CardContent>
      {/* å¯¹æ¯”æ»‘å— */}
      <div className="space-y-4">
        <div className="flex items-center justify-between text-sm">
          <span className="text-muted-foreground">åŸæ–‡</span>
          <span className="text-muted-foreground">æ”¹å†™ç‰ˆ</span>
        </div>
        <div className="relative">
          <input
            type="range"
            min="0"
            max="100"
            value={comparisonSlider}
            onChange={(e) => setComparisonSlider(Number(e.target.value))}
            className="w-full"
          />
        </div>
        {/* å†…å®¹å±•ç¤º */}
        <div className="relative h-[300px] overflow-hidden rounded-lg border">
          <div 
            className="absolute inset-0 p-4 transition-opacity"
            style={{ opacity: comparisonSlider / 100 }}
          >
            <pre className="text-sm whitespace-pre-wrap">{taskStatus.subtitleRaw}</pre>
          </div>
          <div 
            className="absolute inset-0 p-4 bg-purple-950/30 transition-opacity"
            style={{ opacity: 1 - comparisonSlider / 100 }}
          >
            <pre className="text-sm whitespace-pre-wrap">{rewrittenContent}</pre>
          </div>
        </div>
      </div>
      
      {/* æ“ä½œæŒ‰é’® */}
      <div className="flex gap-2 mt-4">
        <Button variant="outline" onClick={() => copyToClipboard(rewrittenContent)}>
          <Copy className="mr-2 h-4 w-4" />
          å¤åˆ¶æ”¹å†™ç‰ˆ
        </Button>
        <Button variant="outline" onClick={handleDownloadRewritten}>
          <Download className="mr-2 h-4 w-4" />
          ä¸‹è½½ SRT
        </Button>
        <Button variant="outline" onClick={handleRewriteAgain}>
          <Sparkles className="mr-2 h-4 w-4" />
          å†æ¬¡æ”¹å†™
        </Button>
      </div>
    </CardContent>
  </Card>
)}
```

---

## ğŸ”§ ä¸‰ã€åç«¯è®¾è®¡æ–¹æ¡ˆ

### 3.1 æ•°æ®åº“ Schema æ›´æ–°

åœ¨ `media_tasks` è¡¨ä¸­æ–°å¢å­—æ®µï¼š

```typescript
// src/config/db/schema.ts
export const mediaTasks = pgTable('media_tasks', {
  // ... ç°æœ‰å­—æ®µ
  
  // æ”¹å†™ç›¸å…³å­—æ®µï¼ˆæ–°å¢ï¼‰
  subtitleRewritten: text('subtitle_rewritten'), // æ”¹å†™åçš„å­—å¹•å†…å®¹ï¼ˆSRTæ ¼å¼ï¼‰
  rewriteStyle: text('rewrite_style'), // æ”¹å†™é£æ ¼ï¼štiktok, youtube, xiaohongshu, weibo, custom
  rewriteRequirement: text('rewrite_requirement'), // ç”¨æˆ·è‡ªå®šä¹‰æ”¹å†™éœ€æ±‚
  rewriteStatus: text('rewrite_status'), // rewriting, completed, failed
  rewriteCreditId: text('rewrite_credit_id'), // æ”¹å†™æ¶ˆè€—çš„ç§¯åˆ†è®°å½•IDï¼ˆç”¨äºé€€æ¬¾ï¼‰
});
```

### 3.2 API è·¯ç”±è®¾è®¡

#### A. æ”¹å†™ APIï¼š`/api/media/rewrite`

```typescript
// src/app/api/media/rewrite/route.ts
export async function POST(request: NextRequest) {
  const { taskId, style, userRequirement } = await request.json();
  
  // 1. éªŒè¯ç”¨æˆ·å’Œä»»åŠ¡
  // 2. æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼ˆå¿…é¡»æ˜¯ extractedï¼‰
  // 3. æ£€æŸ¥ç§¯åˆ†ï¼ˆæ”¹å†™æ¶ˆè€— 8 ç§¯åˆ†ï¼‰
  // 4. è°ƒç”¨ Gemini æ”¹å†™æœåŠ¡
  // 5. ä¿å­˜æ”¹å†™ç»“æœ
  // 6. æ›´æ–°ä»»åŠ¡çŠ¶æ€
}
```

#### B. æ”¹å†™æœåŠ¡ï¼šæ‰©å±• GeminiTranslator

```typescript
// src/shared/services/media/gemini-translator.ts

export class GeminiTranslator {
  /**
   * Rewrite subtitle content with style and custom requirements
   */
  async rewriteSubtitle(
    srtContent: string,
    style: string,
    userRequirement?: string
  ): Promise<string> {
    const prompt = this.buildRewritePrompt(srtContent, style, userRequirement);
    // ... è°ƒç”¨ Gemini API
  }
  
  /**
   * Build rewrite prompt with style and custom requirements
   */
  private buildRewritePrompt(
    text: string,
    style: string,
    userRequirement?: string
  ): string {
    const styleConfigs: Record<string, string> = {
      tiktok: "TikTok çˆ†æ¬¾æ¨¡å¼ï¼šå‰3ç§’é»„é‡‘é’©å­ï¼Œå¼ºèŠ‚å¥æ„Ÿï¼Œé«˜é¢‘æƒ…ç»ªè¯ï¼Œä½¿ç”¨å£è¯­åŒ–è¡¨è¾¾ï¼ŒåŠ å…¥çƒ­é—¨è¯é¢˜æ ‡ç­¾ã€‚",
      youtube: "YouTube æ·±åº¦æ¨¡å¼ï¼šç»“æ„åŒ–å†…å®¹ï¼Œé•¿çº¿é€»è¾‘ï¼Œå¹²è´§å¯†åº¦å¤§ï¼Œä¸“ä¸šæœ¯è¯­å‡†ç¡®ï¼Œé€‚åˆæ·±åº¦è§‚çœ‹ã€‚",
      xiaohongshu: "å°çº¢ä¹¦é£æ ¼ï¼šç§è‰æ–‡æ¡ˆï¼Œemoji ä¸°å¯Œï¼Œäº’åŠ¨æ€§å¼ºï¼Œä½¿ç”¨"å§å¦¹"ç­‰äº²åˆ‡ç§°å‘¼ï¼Œçªå‡ºäº§å“äº®ç‚¹ã€‚",
      weibo: "å¾®åšé£æ ¼ï¼šçƒ­ç‚¹ç»“åˆï¼Œè¯é¢˜æ€§å¼ºï¼Œä½¿ç”¨ç½‘ç»œæµè¡Œè¯­ï¼Œé€‚åˆå¿«é€Ÿä¼ æ’­ï¼ŒåŠ å…¥è¯é¢˜æ ‡ç­¾ã€‚",
    };
    
    const baseInstructions = styleConfigs[style] || styleConfigs.tiktok;
    
    // ç”¨æˆ·è‡ªå®šä¹‰éœ€æ±‚ä¼˜å…ˆçº§æœ€é«˜
    const customSection = userRequirement 
      ? `ã€ç”¨æˆ·ç‰¹å®šè¦æ±‚ã€‘ï¼ˆå¿…é¡»ä¼˜å…ˆæ»¡è¶³ï¼‰ï¼š${userRequirement}` 
      : "è¯·æŒ‰ç…§é¢„è®¾é£æ ¼è¿›è¡Œè‡ªç”±å‘æŒ¥ã€‚";
    
    return `
ä½ æ˜¯ä¸€ä¸ªé¡¶çº§çš„çŸ­è§†é¢‘æ–‡æ¡ˆæ”¹å†™ä¸“å®¶ã€‚
ä½ çš„ä»»åŠ¡æ˜¯å°†ä¸‹æ–¹çš„åŸå§‹å­—å¹•æ”¹å†™æˆçˆ†æ¬¾æ–‡æ¡ˆã€‚

ã€æ ¸å¿ƒæŒ‡å¯¼å‡†åˆ™ã€‘ï¼š
1. ${baseInstructions}
2. ä¸¥ç¦ AI è…”è°ƒï¼Œä½¿ç”¨åœ°é“å£è¯­ã€‚
3. ä¿æŒæ—¶é—´æˆ³æ ¼å¼ä¸å˜ï¼ˆSRT æ ¼å¼ï¼‰ã€‚
4. ${customSection}
5. æ”¹å†™åçš„æ–‡æ¡ˆè¦æ›´æœ‰å¸å¼•åŠ›ï¼Œèƒ½æå‡å®Œæ’­ç‡å’Œäº’åŠ¨ç‡ã€‚

ã€åŸå§‹å­—å¹•ã€‘ï¼š
"""
${text}
"""

è¯·ç›´æ¥è¾“å‡ºæ”¹å†™åçš„ SRT æ ¼å¼æ–‡æ¡ˆï¼Œä¿æŒæ—¶é—´æˆ³å’Œåºå·ä¸å˜ï¼Œåªæ”¹å†™æ–‡æœ¬å†…å®¹ã€‚
`;
  }
}
```

### 3.3 æµå¼æ”¹å†™ï¼ˆå¯é€‰ï¼Œæå‡ç”¨æˆ·ä½“éªŒï¼‰

å¦‚æœéœ€è¦æµå¼è¿”å›æ”¹å†™ç»“æœï¼ˆç±»ä¼¼æ‰“å­—æœºæ•ˆæœï¼‰ï¼š

```typescript
// ä½¿ç”¨ Gemini çš„æµå¼ API
async rewriteSubtitleStream(
  srtContent: string,
  style: string,
  userRequirement?: string
): Promise<ReadableStream> {
  // è°ƒç”¨ Gemini æµå¼ API
  // è¿”å› ReadableStream ä¾›å‰ç«¯å®æ—¶æ˜¾ç¤º
}
```

---

## ğŸ”„ å››ã€å®Œæ•´ä¸šåŠ¡æµç¨‹

### 4.1 æµç¨‹æ—¶åºå›¾

```
ç”¨æˆ·æ“ä½œæµç¨‹ï¼š
1. è¾“å…¥ URL â†’ æäº¤æå–ä»»åŠ¡
2. ç­‰å¾…æå–å®Œæˆï¼ˆstatus: extractedï¼‰
3. æ˜¾ç¤ºå­—å¹•é¢„è§ˆ
4. ã€æ–°å¢ã€‘é€‰æ‹©æ”¹å†™é£æ ¼ + è¾“å…¥è‡ªå®šä¹‰éœ€æ±‚
5. ã€æ–°å¢ã€‘ç‚¹å‡»"å¼€å§‹æ”¹å†™" â†’ è°ƒç”¨ /api/media/rewrite
6. ã€æ–°å¢ã€‘æ˜¾ç¤ºæ”¹å†™ç»“æœï¼ˆå¯¹æ¯”æ»‘å—ï¼‰
7. å¯é€‰ï¼šé€‰æ‹©ç›®æ ‡è¯­è¨€ â†’ ç¿»è¯‘æ”¹å†™åçš„æ–‡æ¡ˆ
8. ä¸‹è½½æœ€ç»ˆç»“æœï¼ˆæ”¹å†™ç‰ˆæˆ–ç¿»è¯‘ç‰ˆï¼‰
```

### 4.2 çŠ¶æ€æµè½¬

```
pending â†’ processing â†’ extracted â†’ [rewriting] â†’ [rewritten] â†’ [translating] â†’ completed
                                    â†‘ æ–°å¢çŠ¶æ€
```

**æ–°å¢çŠ¶æ€**ï¼š
- `rewriting` - æ­£åœ¨æ”¹å†™
- `rewritten` - æ”¹å†™å®Œæˆï¼ˆå¯é€‰ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¦†ç›– `subtitleRaw`ï¼‰

### 4.3 ç§¯åˆ†æ¶ˆè€—

- **æå–å­—å¹•**: 10 ç§¯åˆ†
- **æ”¹å†™æ–‡æ¡ˆ**: 8 ç§¯åˆ†ï¼ˆæ–°å¢ï¼‰
- **ç¿»è¯‘å­—å¹•**: 5 ç§¯åˆ†

**æ€»æµç¨‹ç§¯åˆ†**ï¼š
- æå– + æ”¹å†™ï¼š18 ç§¯åˆ†
- æå– + æ”¹å†™ + ç¿»è¯‘ï¼š23 ç§¯åˆ†

---

## ğŸ¨ äº”ã€UI ç»„ä»¶è¯¦ç»†è®¾è®¡

### 5.1 æ”¹å†™åŠŸèƒ½åŒºåŸŸå®Œæ•´ä»£ç 

```tsx
{/* æ”¹å†™åŠŸèƒ½åŒºåŸŸ - ä»…åœ¨ extracted çŠ¶æ€ä¸”å­˜åœ¨å­—å¹•æ—¶æ˜¾ç¤º */}
{taskStatus?.status === 'extracted' && taskStatus.subtitleRaw && (
  <Card className="border-purple-500/20 bg-gradient-to-br from-purple-950/20 to-blue-950/20">
    <CardHeader>
      <CardTitle className="flex items-center gap-2">
        <Sparkles className="h-5 w-5 text-purple-400" />
        AI çˆ†æ¬¾æ”¹å†™
        <Badge variant="secondary" className="ml-auto">
          VIP åŠŸèƒ½
        </Badge>
      </CardTitle>
    </CardHeader>
    <CardContent className="space-y-4">
      {/* é£æ ¼é€‰æ‹©å™¨ */}
      <div className="space-y-2">
        <Label>é€‰æ‹©æ”¹å†™é£æ ¼</Label>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
          {REWRITE_STYLES.map((style) => (
            <Button
              key={style.value}
              variant={selectedRewriteStyle === style.value ? "default" : "outline"}
              onClick={() => setSelectedRewriteStyle(style.value)}
              className="h-auto py-3"
              disabled={isRewriting}
            >
              {style.label}
            </Button>
          ))}
        </div>
      </div>
      
      {/* è‡ªå®šä¹‰éœ€æ±‚è¾“å…¥æ¡† */}
      <div className="space-y-2">
        <div className="flex items-center justify-between px-1">
          <Label className="text-xs font-medium text-purple-300/80 uppercase tracking-wider">
            è‡ªå®šä¹‰æ”¹å†™éœ€æ±‚ï¼ˆå¯é€‰ï¼‰
          </Label>
          <span className="text-[10px] text-white/30 italic">
            ä¾‹å¦‚ï¼šæ”¹æˆå¹½é»˜åæ§½é£ / å¢åŠ æ›´å¤š Emoji
          </span>
        </div>
        
        <div className="relative group">
          {/* å‘¼å¸ç¯èƒŒæ™¯ */}
          <div className="absolute -inset-0.5 bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl blur opacity-20 group-hover:opacity-40 transition duration-1000 group-focus-within:animate-pulse" />
          
          {/* è¾“å…¥æ¡† */}
          <textarea
            value={rewriteRequirement}
            onChange={(e) => setRewriteRequirement(e.target.value)}
            placeholder="è¾“å…¥ä½ çš„ç‰¹å®šæ”¹å†™è¦æ±‚ï¼ŒGemini å°†ä¸ºæ‚¨æ·±åº¦å®šåˆ¶..."
            className="relative w-full min-h-[100px] bg-black/60 backdrop-blur-xl border border-white/10 rounded-xl p-4 text-sm text-purple-50 placeholder:text-white/20 focus:outline-none focus:ring-2 focus:ring-purple-500/50 transition-all resize-none"
            disabled={isRewriting}
          />
          
          {/* çŠ¶æ€æŒ‡ç¤ºå™¨ */}
          <div className="absolute bottom-3 right-3 flex items-center gap-2">
            {rewriteRequirement.length > 0 && (
              <button 
                onClick={() => setRewriteRequirement('')}
                className="text-[10px] text-white/40 hover:text-white/80 transition-colors bg-white/5 px-2 py-1 rounded-md"
              >
                é‡ç½®
              </button>
            )}
            <div className={`w-1.5 h-1.5 rounded-full ${rewriteRequirement ? 'bg-purple-500 animate-ping' : 'bg-white/10'}`} />
          </div>
        </div>
        
        {/* å¿«æ·éœ€æ±‚æ ‡ç­¾ */}
        <div className="flex flex-wrap gap-2">
          {QUICK_REQUIREMENTS.map((req) => (
            <button
              key={req}
              onClick={() => setRewriteRequirement(req)}
              className="text-xs px-3 py-1.5 rounded-md border border-white/5 bg-white/5 text-white/40 hover:bg-purple-500/20 hover:text-purple-300 transition-all"
              disabled={isRewriting}
            >
              + {req}
            </button>
          ))}
        </div>
      </div>
      
      {/* æ”¹å†™æŒ‰é’® */}
      <Button
        onClick={handleRewrite}
        disabled={!selectedRewriteStyle || isRewriting}
        className="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700"
        size="lg"
      >
        {isRewriting ? (
          <>
            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
            AI æ­£åœ¨æ”¹å†™ä¸­...
          </>
        ) : (
          <>
            <Sparkles className="mr-2 h-4 w-4" />
            {rewriteRequirement ? 'æŒ‰è¦æ±‚æ”¹å†™' : 'å¼€å§‹æ”¹å†™'}
          </>
        )}
      </Button>
      
      {/* æ”¹å†™ç»“æœå±•ç¤º */}
      {rewrittenContent && (
        <div className="mt-4 space-y-4">
          {/* å¯¹æ¯”æ»‘å— */}
          <div className="space-y-2">
            <div className="flex items-center justify-between text-sm">
              <span className="text-muted-foreground">åŸæ–‡</span>
              <span className="text-muted-foreground">æ”¹å†™ç‰ˆ</span>
            </div>
            <input
              type="range"
              min="0"
              max="100"
              value={comparisonSlider}
              onChange={(e) => setComparisonSlider(Number(e.target.value))}
              className="w-full"
            />
          </div>
          
          {/* å†…å®¹å¯¹æ¯” */}
          <div className="relative h-[300px] overflow-auto rounded-lg border bg-background">
            <div className="p-4">
              <div 
                className="absolute inset-0 p-4 transition-opacity"
                style={{ opacity: comparisonSlider / 100 }}
              >
                <pre className="text-sm whitespace-pre-wrap font-mono">
                  {taskStatus.subtitleRaw}
                </pre>
              </div>
              <div 
                className="absolute inset-0 p-4 bg-purple-950/30 transition-opacity"
                style={{ opacity: 1 - comparisonSlider / 100 }}
              >
                <pre className="text-sm whitespace-pre-wrap font-mono text-purple-100">
                  {rewrittenContent}
                </pre>
              </div>
            </div>
          </div>
          
          {/* æ“ä½œæŒ‰é’® */}
          <div className="flex gap-2">
            <Button variant="outline" onClick={() => copyToClipboard(rewrittenContent)}>
              <Copy className="mr-2 h-4 w-4" />
              å¤åˆ¶æ”¹å†™ç‰ˆ
            </Button>
            <Button variant="outline" onClick={handleDownloadRewritten}>
              <Download className="mr-2 h-4 w-4" />
              ä¸‹è½½ SRT
            </Button>
            <Button variant="outline" onClick={handleRewriteAgain}>
              <Sparkles className="mr-2 h-4 w-4" />
              å†æ¬¡æ”¹å†™
            </Button>
          </div>
        </div>
      )}
    </CardContent>
  </Card>
)}
```

---

## ğŸ“Š å…­ã€æŠ€æœ¯å®ç°ç»†èŠ‚

### 6.1 å‰ç«¯ Hookï¼š`useMediaRewrite`

```typescript
// src/shared/hooks/use-media-rewrite.ts
export function useMediaRewrite() {
  const [isRewriting, setIsRewriting] = useState(false);
  const [rewrittenContent, setRewrittenContent] = useState<string | null>(null);
  
  const rewrite = async (
    taskId: string,
    style: string,
    userRequirement?: string
  ): Promise<boolean> => {
    setIsRewriting(true);
    try {
      const resp = await fetch('/api/media/rewrite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ taskId, style, userRequirement }),
      });
      
      const { code, data } = await resp.json();
      if (code === 0) {
        setRewrittenContent(data.rewrittenContent);
        return true;
      }
      return false;
    } finally {
      setIsRewriting(false);
    }
  };
  
  return { rewrite, isRewriting, rewrittenContent };
}
```

### 6.2 åç«¯ API å®ç°

```typescript
// src/app/api/media/rewrite/route.ts
export async function POST(request: NextRequest) {
  const { taskId, style, userRequirement } = await request.json();
  
  // 1. éªŒè¯
  const user = await getUserInfo();
  const task = await findMediaTaskById(taskId);
  
  // 2. æ£€æŸ¥çŠ¶æ€
  if (task.status !== 'extracted' || !task.subtitleRaw) {
    return respErr('Task is not ready for rewriting');
  }
  
  // 3. æ£€æŸ¥ç§¯åˆ†ï¼ˆ8 ç§¯åˆ†ï¼‰
  const requiredCredits = 8;
  const remainingCredits = await getRemainingCredits(user.id);
  if (remainingCredits < requiredCredits) {
    return respErr(`Insufficient credits. Required: ${requiredCredits}`);
  }
  
  // 4. æ¶ˆè€—ç§¯åˆ†
  const consumedCredit = await consumeCredits({
    userId: user.id,
    credits: requiredCredits,
    scene: 'payment',
    description: `Content rewrite: ${style}`,
  });
  
  // 5. æ›´æ–°çŠ¶æ€
  await updateMediaTaskById(taskId, {
    rewriteStatus: 'rewriting',
    rewriteStyle: style,
    rewriteRequirement: userRequirement || null,
    rewriteCreditId: consumedCredit.id,
  });
  
  try {
    // 6. è°ƒç”¨ Gemini æ”¹å†™
    const translator = await getGeminiTranslator();
    const rewrittenContent = await translator.rewriteSubtitle(
      task.subtitleRaw,
      style,
      userRequirement
    );
    
    // 7. ä¿å­˜ç»“æœ
    await updateMediaTaskById(taskId, {
      subtitleRewritten: rewrittenContent,
      rewriteStatus: 'completed',
    });
    
    return respData({ rewrittenContent });
  } catch (error) {
    await updateMediaTaskById(taskId, {
      rewriteStatus: 'failed',
      errorMessage: error.message,
    });
    throw error;
  }
}
```

---

## ğŸ¯ ä¸ƒã€å®æ–½è®¡åˆ’

### Phase 1: æ•°æ®åº“å’ŒåŸºç¡€ APIï¼ˆ1-2 å¤©ï¼‰

1. âœ… æ›´æ–°æ•°æ®åº“ Schemaï¼ˆæ–°å¢æ”¹å†™ç›¸å…³å­—æ®µï¼‰
2. âœ… åˆ›å»º `/api/media/rewrite` è·¯ç”±
3. âœ… æ‰©å±• `GeminiTranslator` ç±»ï¼ˆæ·»åŠ æ”¹å†™æ–¹æ³•ï¼‰
4. âœ… æµ‹è¯• API åŠŸèƒ½

### Phase 2: å‰ç«¯ UIï¼ˆ2-3 å¤©ï¼‰

1. âœ… åˆ›å»º `useMediaRewrite` Hook
2. âœ… åœ¨ `MediaExtractor` ç»„ä»¶ä¸­æ·»åŠ æ”¹å†™åŠŸèƒ½åŒºåŸŸ
3. âœ… å®ç°é£æ ¼é€‰æ‹©å™¨
4. âœ… å®ç°è‡ªå®šä¹‰éœ€æ±‚è¾“å…¥æ¡†ï¼ˆç´«è‰²å‘¼å¸ç¯æ•ˆæœï¼‰
5. âœ… å®ç°æ”¹å†™ç»“æœå±•ç¤ºï¼ˆå¯¹æ¯”æ»‘å—ï¼‰
6. âœ… é›†æˆåˆ°ç°æœ‰æµç¨‹

### Phase 3: ä¼˜åŒ–å’Œæµ‹è¯•ï¼ˆ1-2 å¤©ï¼‰

1. âœ… æµå¼æ”¹å†™ï¼ˆå¯é€‰ï¼Œæå‡ç”¨æˆ·ä½“éªŒï¼‰
2. âœ… é”™è¯¯å¤„ç†ä¼˜åŒ–
3. âœ… UI/UX ä¼˜åŒ–
4. âœ… å®Œæ•´æµ‹è¯•

---

## ğŸ“ å…«ã€å…³é”®è®¾è®¡å†³ç­–

### 8.1 æ”¹å†™ç»“æœå­˜å‚¨

**æ–¹æ¡ˆ A**ï¼šæ–°å¢å­—æ®µ `subtitleRewritten`
- âœ… ä¿ç•™åŸæ–‡å’Œæ”¹å†™ç‰ˆ
- âœ… æ”¯æŒå¯¹æ¯”æŸ¥çœ‹
- âœ… æ”¯æŒå¤šæ¬¡æ”¹å†™

**æ–¹æ¡ˆ B**ï¼šç›´æ¥è¦†ç›– `subtitleRaw`
- âŒ ä¸¢å¤±åŸæ–‡
- âŒ æ— æ³•å¯¹æ¯”

**æ¨è**ï¼šæ–¹æ¡ˆ Aï¼ˆæ–°å¢å­—æ®µï¼‰

### 8.2 æ”¹å†™åç¿»è¯‘

**æµç¨‹**ï¼š
1. æå– â†’ `subtitleRaw`
2. æ”¹å†™ â†’ `subtitleRewritten`
3. ç¿»è¯‘ â†’ å¯ä»¥é€‰æ‹©ç¿»è¯‘åŸæ–‡æˆ–æ”¹å†™ç‰ˆ

**å®ç°**ï¼š
- ç¿»è¯‘ API å¢åŠ å‚æ•°ï¼š`sourceType: 'original' | 'rewritten'`
- é»˜è®¤ç¿»è¯‘æ”¹å†™ç‰ˆï¼ˆå¦‚æœå­˜åœ¨ï¼‰

### 8.3 ç§¯åˆ†ç­–ç•¥

- **æ”¹å†™**: 8 ç§¯åˆ†ï¼ˆä¸­ç­‰æˆæœ¬ï¼Œé¼“åŠ±ä½¿ç”¨ï¼‰
- **å…è´¹è¯•ç”¨**: å¯ä»¥åŒ…å« 1 æ¬¡æ”¹å†™
- **VIP åŠŸèƒ½**: å¯ä»¥æ ‡è®°ä¸º VIP ä¸“å±åŠŸèƒ½

---

## âœ… ä¹ã€å®æ–½æ£€æŸ¥æ¸…å•

### æ•°æ®åº“
- [ ] æ›´æ–° Schemaï¼ˆæ–°å¢æ”¹å†™å­—æ®µï¼‰
- [ ] è¿è¡Œæ•°æ®åº“è¿ç§»
- [ ] éªŒè¯å­—æ®µåˆ›å»º

### åç«¯
- [ ] æ‰©å±• `GeminiTranslator` ç±»
- [ ] åˆ›å»º `/api/media/rewrite` è·¯ç”±
- [ ] å®ç°ç§¯åˆ†æ‰£é™¤é€»è¾‘
- [ ] å®ç°é”™è¯¯å¤„ç†å’Œå›æ»š

### å‰ç«¯
- [ ] åˆ›å»º `useMediaRewrite` Hook
- [ ] æ·»åŠ æ”¹å†™åŠŸèƒ½åŒºåŸŸ UI
- [ ] å®ç°é£æ ¼é€‰æ‹©å™¨
- [ ] å®ç°è‡ªå®šä¹‰éœ€æ±‚è¾“å…¥æ¡†
- [ ] å®ç°æ”¹å†™ç»“æœå±•ç¤º
- [ ] é›†æˆåˆ°ç°æœ‰æµç¨‹

### æµ‹è¯•
- [ ] å•å…ƒæµ‹è¯•
- [ ] é›†æˆæµ‹è¯•
- [ ] UI æµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•

---

## ğŸš€ åã€é¢„æœŸæ•ˆæœ

### ç”¨æˆ·ä½“éªŒæå‡

1. **åŠŸèƒ½å®Œæ•´æ€§**: ä»"æå–å·¥å…·"å‡çº§ä¸º"åˆ›ä½œå·¥ä½œç«™"
2. **ä¸ªæ€§åŒ–**: æ”¯æŒè‡ªå®šä¹‰éœ€æ±‚ï¼Œæ»¡è¶³å¤šæ ·åŒ–åœºæ™¯
3. **è§†è§‰å†²å‡»**: ç´«è‰²å‘¼å¸ç¯æ•ˆæœï¼Œæå‡äº§å“è´¨æ„Ÿ
4. **å¯¹æ¯”åŠŸèƒ½**: æ»‘å—å¯¹æ¯”ï¼Œç›´è§‚å±•ç¤ºæ”¹å†™æ•ˆæœ

### å•†ä¸šä»·å€¼

1. **å·®å¼‚åŒ–ç«äº‰**: æ”¹å†™åŠŸèƒ½æ˜¯ç‹¬ç‰¹å–ç‚¹
2. **ä»˜è´¹è½¬åŒ–**: VIP åŠŸèƒ½ï¼Œæå‡ä»˜è´¹ç‡
3. **ç”¨æˆ·ç²˜æ€§**: å¤šæ¬¡æ”¹å†™ï¼Œå¢åŠ ä½¿ç”¨é¢‘æ¬¡
4. **SEO ä¼˜åŒ–**: "AI æ–‡æ¡ˆæ”¹å†™å·¥å…·"å…³é”®è¯ä¼˜åŒ–

---

**æ–¹æ¡ˆè®¾è®¡å®Œæˆæ—¶é—´**: 2024-12-25  
**çŠ¶æ€**: âœ… æ–¹æ¡ˆå·²è®¾è®¡ï¼Œç­‰å¾…æ‰¹å‡†æ‰§è¡Œ
