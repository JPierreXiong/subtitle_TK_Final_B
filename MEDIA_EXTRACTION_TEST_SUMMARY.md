# 📊 Media Extraction 测试报告

## 测试概况

**测试时间**: 2026-01-17  
**测试 URL**: https://www.tiktok.com/@eharmonyofficial/video/7587079480779296014  
**测试环境**: http://localhost:3000

---

## ✅ 测试结果总结

| 测试项 | 状态 | 说明 |
|--------|------|------|
| 服务器连接 | ✅ PASS | 服务器正常运行 |
| 用户认证 | ✅ PASS | 成功注册并登录 |
| 文案提取任务提交 | ✅ PASS | 任务成功提交（taskId: `5bce785e-acd7-4b35-9e58-5de486b036f7`） |
| 文案提取状态轮询 | ⚠️ 部分失败 | 轮询时 cookies 未传递，导致认证失败 |
| 视频提取任务提交 | ❌ FAIL | 积分不足（新用户无积分） |
| 视频提取状态轮询 | - | 未执行（任务提交失败） |

---

## 📝 详细分析

### 1. ✅ 服务器连接 (PASS)

- **状态**: 成功
- **响应时间**: 293ms
- **说明**: 服务器正常运行，可以接收请求

### 2. ✅ 用户认证 (PASS)

- **状态**: 成功
- **流程**: 自动注册新用户 → 登录成功
- **说明**: 认证流程正常，session 建立成功

### 3. ✅ 文案提取任务提交 (PASS)

- **状态**: 成功
- **Task ID**: `5bce785e-acd7-4b35-9e58-5de486b036f7`
- **输出类型**: `subtitle`
- **响应时间**: 50.585秒（包含 8 秒认证超时等待）
- **说明**: 
  - 任务成功提交到 QStash 队列
  - Worker 路由应该已经开始处理任务
  - 虽然提交响应较慢（50秒），但最终成功

### 4. ⚠️ 文案提取状态轮询 (部分失败)

- **状态**: 认证失败
- **问题**: 轮询状态时 cookies 未正确传递
- **表现**: 持续收到 "no auth, please sign in" 错误
- **影响**: 无法获取任务状态更新
- **修复**: 已在测试脚本中修复，下次运行应正常

### 5. ❌ 视频提取任务提交 (FAIL)

- **状态**: 积分不足
- **错误**: "Insufficient credits. Required: 15, Available: 0"
- **说明**: 
  - 新注册用户没有积分
  - 视频提取需要 15 积分
  - 这是预期的业务逻辑，不是 bug

---

## 🔍 关键发现

### 1. 认证超时问题

**现象**: 任务提交耗时 50 秒，触发了 8 秒的认证超时机制

**分析**:
- `getUserInfo()` 调用耗时超过 8 秒
- 可能原因：
  1. 数据库查询慢（Supabase 连接延迟）
  2. 新用户 session 需要时间稳定
  3. Cold start（首次请求初始化）

**建议**:
- ✅ 已增加 session 稳定等待时间（2秒）
- ⚠️ 可以进一步优化数据库查询性能
- ⚠️ 考虑在测试中使用已有用户而非新注册用户

### 2. 积分不足问题

**现象**: 视频提取需要 15 积分，新用户无积分

**分析**:
- 这是预期的业务逻辑
- 文案提取可能使用了免费试用

**建议**:
- 测试时可以使用有积分的账户
- 或者先执行签到（check-in）获取免费积分
- 或者测试文案提取功能（可能不需要积分）

### 3. 任务状态轮询问题

**现象**: 轮询时 cookies 未传递，导致认证失败

**分析**:
- 测试脚本中 `pollTaskStatus` 函数未传递 cookies 参数
- 这导致每次轮询请求都无法通过认证

**修复**: ✅ 已在测试脚本中修复

---

## 📊 性能指标

| 操作 | 耗时 | 说明 |
|------|------|------|
| 服务器连接 | 293ms | 正常 |
| 用户认证 | ~2s | 正常（注册 + 登录） |
| 任务提交（文案） | 50.585s | 较慢（包含认证超时） |
| 任务提交（视频） | 30.936s | 超时后返回积分不足 |

---

## 🎯 测试结论

### ✅ 成功的部分

1. **服务器正常运行**: 可以正常接收和处理请求
2. **认证流程正常**: 注册和登录功能正常
3. **任务提交成功**: 文案提取任务成功提交到 QStash
4. **Worker 路由激活**: 任务应该已在后台处理

### ⚠️ 需要改进的部分

1. **认证性能**: `getUserInfo()` 调用耗时较长（>8秒）
   - 建议优化数据库查询
   - 考虑使用连接池预热

2. **轮询认证**: 已修复，下次测试应正常

3. **积分管理**: 
   - 测试环境可以使用测试账户或签到功能
   - 或者专注于测试文案提取（可能免费）

### 🚀 下一步建议

1. **优化认证性能**
   - 检查 Supabase 连接配置
   - 验证数据库查询索引
   - 考虑使用缓存

2. **完善测试脚本**
   - ✅ 已修复 cookies 传递问题
   - 可以添加签到功能获取免费积分
   - 可以添加任务完成验证

3. **验证 Worker 处理**
   - 检查 Worker 路由日志
   - 验证任务是否正常处理
   - 检查 Supabase Realtime 是否工作

---

## 📄 完整测试报告

详细测试报告已保存到: `MEDIA_EXTRACTION_TEST_REPORT.md`

---

**测试完成时间**: 2026-01-17T04:54:00Z  
**测试状态**: 部分成功，需要优化认证性能和积分管理
