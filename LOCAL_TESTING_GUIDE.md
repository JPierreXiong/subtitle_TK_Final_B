# 本地测试指南

## 🚀 服务器状态

开发服务器已重新启动，运行在：**http://localhost:3000**

---

## 🧪 测试清单

### 1. 基础功能测试

#### ✅ 访问应用
- 打开浏览器访问：http://localhost:3000
- 检查页面是否正常加载
- 检查是否有控制台错误

#### ✅ 用户认证
- 测试登录功能
- 检查用户信息是否正确显示
- 检查积分余额显示

---

### 2. 视频提取功能测试

#### ✅ 提取 TikTok 视频
1. 输入 TikTok URL（例如：`https://www.tiktok.com/@user/video/1234567890`）
2. 选择输出类型：**字幕** 或 **视频**
3. 点击"提取"按钮
4. **预期结果**：
   - 立即返回 202 Accepted 和 `taskId`
   - 状态显示"处理中"
   - 控制台显示 QStash 推送日志（如果配置了 QStash）

#### ✅ 提取 YouTube 视频
1. 输入 YouTube URL
2. 选择输出类型
3. 点击"提取"按钮
4. **预期结果**：同上

#### ✅ 检查任务状态
- 观察状态流转：`pending → downloading → processing → extracted`
- 检查进度条更新
- 检查字幕内容是否正确显示

---

### 3. QStash 异步处理测试

#### ✅ 检查 QStash 集成
1. **如果配置了 QStash Token**：
   - 查看控制台日志，确认任务已推送到 QStash
   - 访问 [Upstash Console](https://console.upstash.com/) 查看任务队列
   - 检查 Worker 路由是否被调用

2. **如果未配置 QStash Token**：
   - 应该自动 fallback 到直接处理
   - 查看控制台警告信息

#### ✅ 检查 Worker 路由
- 查看控制台日志中的 Worker 处理信息
- 检查幂等性日志（如果有重复调用）
- 检查状态更新日志

---

### 4. 翻译功能测试

#### ✅ 翻译字幕
1. 等待提取完成（status: extracted）
2. 选择目标语言（例如：中文）
3. 点击"开始翻译"按钮
4. **预期结果**：
   - 状态更新为 `translating`
   - 进度显示
   - 翻译完成后状态为 `completed`
   - 显示翻译后的字幕

---

### 5. 下载功能测试

#### ✅ 下载字幕文件
- 测试下载原始字幕（SRT）
- 测试下载翻译后的字幕（SRT）
- 测试下载 CSV 格式

#### ✅ 下载视频（如果选择了视频输出）
- 测试视频下载功能
- 检查预签名 URL 是否有效

---

### 6. 错误处理测试

#### ✅ 测试错误场景
- 无效 URL（应该显示错误提示）
- 积分不足（应该显示积分不足提示）
- 网络错误（应该显示友好错误信息）
- 任务失败（应该显示错误信息并回滚积分）

---

### 7. 性能测试

#### ✅ 内存监控
- 打开浏览器开发者工具
- 监控内存使用情况
- 测试大文件视频处理（如果可能）

#### ✅ 响应时间
- 检查 API 响应时间（应该在 200ms 内）
- 检查状态更新频率
- 检查页面加载速度

---

## 🔍 调试技巧

### 查看控制台日志

**前端日志**：
- 打开浏览器开发者工具（F12）
- 查看 Console 标签
- 查看 Network 标签（检查 API 请求）

**后端日志**：
- 查看终端/控制台输出
- 查找 QStash 相关日志
- 查找 Worker 处理日志
- 查找错误信息

### 检查环境变量

```bash
# 检查环境变量是否加载
# 在代码中添加临时日志
console.log('QSTASH_TOKEN:', process.env.QSTASH_TOKEN ? '已配置' : '未配置');
```

### 检查数据库连接

- 检查 Supabase 连接是否正常
- 检查任务是否正确保存到数据库
- 检查状态更新是否及时

---

## 📊 测试数据

### 测试 URL（建议）

**TikTok**：
- `https://www.tiktok.com/@user/video/1234567890`
- 或使用真实的 TikTok 视频 URL

**YouTube**：
- `https://www.youtube.com/watch?v=dQw4w9WgXcQ`
- 或使用真实的 YouTube 视频 URL

---

## ⚠️ 常见问题排查

### 1. 服务器无法启动
- 检查端口 3000 是否被占用
- 检查 Node.js 版本（需要 >= 22.21.1）
- 检查依赖是否完整安装

### 2. QStash 401 错误
- 检查 `QSTASH_TOKEN` 是否正确
- 检查 `QSTASH_CURRENT_SIGNING_KEY` 是否正确
- 检查 Worker 路由的签名验证逻辑

### 3. 任务不处理
- 检查 QStash Dashboard 中的任务状态
- 检查 Worker 路由日志
- 检查数据库中的任务状态

### 4. 环境变量未加载
- 确认 `.env.local` 文件在项目根目录
- 重启开发服务器
- 检查环境变量名称是否正确

---

## ✅ 测试完成检查清单

- [ ] 服务器成功启动
- [ ] 页面正常加载
- [ ] 用户认证正常
- [ ] 视频提取功能正常
- [ ] QStash 集成正常（如果配置）
- [ ] Worker 路由正常执行
- [ ] 状态更新正常
- [ ] 翻译功能正常
- [ ] 下载功能正常
- [ ] 错误处理正常
- [ ] 性能表现良好

---

## 🎯 下一步

测试完成后，如果发现问题：
1. 记录错误信息
2. 检查相关日志
3. 根据错误信息进行修复

如果测试通过，可以：
1. 准备部署到 Vercel
2. 配置生产环境变量
3. 进行生产环境测试

---

**测试开始时间**: 2024-12-25  
**服务器地址**: http://localhost:3000  
**状态**: ✅ 服务器已启动，可以开始测试
