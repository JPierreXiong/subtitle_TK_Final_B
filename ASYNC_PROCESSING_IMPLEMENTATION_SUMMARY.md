# å¼‚æ­¥å¤„ç†æ–¹æ¡ˆå®æ–½æ€»ç»“

## âœ… å®æ–½å®ŒæˆçŠ¶æ€

**å®æ–½æ—¶é—´**: 2024-12-25  
**æ–¹æ¡ˆçŠ¶æ€**: âœ… å·²å®æ–½ï¼Œç­‰å¾…æµ‹è¯•éªŒè¯

---

## ğŸ“‹ å·²å®Œæˆçš„å®æ–½é¡¹

### 1. âœ… å®‰è£…ä¾èµ–

```bash
pnpm add @upstash/qstash
```

**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

### 2. âœ… åˆ›å»º Worker è·¯ç”±

**æ–‡ä»¶**: `src/app/api/media/worker/route.ts`

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… QStash ç­¾åéªŒè¯
- âœ… å¹‚ç­‰æ€§æ£€æŸ¥ï¼ˆé˜²æ­¢é‡å¤å¤„ç†ï¼‰
- âœ… ç»†åŒ–çŠ¶æ€æ›´æ–°ï¼ˆdownloading â†’ processing â†’ extractedï¼‰
- âœ… æµå¼å¤„ç†ï¼ˆå†…å­˜å®‰å…¨ï¼‰
- âœ… ç¼“å­˜æ”¯æŒ
- âœ… é”™è¯¯å¤„ç†å’Œå›æ»š

**å…³é”®ä»£ç ç‰¹æ€§**:
```typescript
// å¹‚ç­‰æ€§æ£€æŸ¥
if (existingTask.status === 'completed' || existingTask.status === 'extracted') {
  return Response.json({ success: true, message: 'Task already completed' });
}

// ç»†åŒ–çŠ¶æ€
await updateMediaTaskById(taskId, { status: 'downloading', progress: 10 });
await updateMediaTaskById(taskId, { status: 'processing', progress: 20 });
```

**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

### 3. âœ… ä¿®æ”¹ Submit è·¯ç”±

**æ–‡ä»¶**: `src/app/api/media/submit/route.ts`

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… 4ç§’ç†”æ–­æœºåˆ¶ï¼ˆ`getUserInfoWithTimeout`ï¼‰
- âœ… QStash ä»»åŠ¡æ¨é€
- âœ… è¿”å› 202 Accepted
- âœ… Fallback æœºåˆ¶ï¼ˆQStash æœªé…ç½®æ—¶ä½¿ç”¨ç›´æ¥å¤„ç†ï¼‰

**å…³é”®ä»£ç ç‰¹æ€§**:
```typescript
// 4ç§’ç†”æ–­
const currentUser = await getUserInfoWithTimeout(4000);

// QStash æ¨é€
await qstash.publishJSON({
  url: `${process.env.NEXT_PUBLIC_APP_URL}/api/media/worker`,
  body: { taskId, url, outputType, userId },
});

// è¿”å› 202
return respData({ taskId, message: 'Task submitted successfully' }, 202);
```

**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

### 4. âœ… æ›´æ–°çŠ¶æ€ç±»å‹å®šä¹‰

**æ–‡ä»¶**: `src/shared/models/media_task.ts`

**æ›´æ–°å†…å®¹**:
```typescript
export type MediaTaskStatus =
  | 'pending'      // å·²å…¥é˜Ÿï¼Œç­‰å¾…å¤„ç†
  | 'downloading'  // æ­£åœ¨ä»å¹³å°ä¸‹è½½è§†é¢‘æµ
  | 'processing'   // æ­£åœ¨æå–æ–‡æ¡ˆï¼ˆASRï¼‰
  | 'extracted'    // æå–å®Œæˆï¼Œç­‰å¾…ç¿»è¯‘
  | 'translating'  // æ­£åœ¨ç¿»è¯‘
  | 'completed'    // å¤„ç†å®Œæˆ
  | 'failed';      // å¤„ç†å¤±è´¥
```

**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

### 5. âœ… é…ç½® Vercel

**æ–‡ä»¶**: `vercel.json`

**æ›´æ–°å†…å®¹**:
```json
{
  "functions": {
    "src/app/api/media/worker/route.ts": {
      "maxDuration": 300
    }
  }
}
```

**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ”§ ç¯å¢ƒå˜é‡é…ç½®

### å¿…éœ€çš„ç¯å¢ƒå˜é‡

```env
# QStash Configuration
QSTASH_TOKEN=qst_xxx
QSTASH_CURRENT_SIGNING_KEY=sig_xxx
QSTASH_NEXT_SIGNING_KEY=sig_xxx  # ç”¨äºå¯†é’¥è½®æ¢

# Application URL (ç”¨äº QStash å›è°ƒ)
NEXT_PUBLIC_APP_URL=https://your-app.vercel.app
```

### è·å– QStash Token

1. è®¿é—® [Upstash Console](https://console.upstash.com/)
2. åˆ›å»º QStash é¡¹ç›®
3. å¤åˆ¶ Token å’Œ Signing Keys
4. åœ¨ Vercel ç¯å¢ƒå˜é‡ä¸­é…ç½®

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### Phase 1: åŸºç¡€æ¡æ‰‹æµ‹è¯•

**ç›®æ ‡**: éªŒè¯ Submit â†’ QStash â†’ Worker çš„åŸºç¡€æµç¨‹

**æµ‹è¯•æ­¥éª¤**:
1. é…ç½® QStash Token
2. æäº¤ä¸€ä¸ªæµ‹è¯•ä»»åŠ¡
3. æ£€æŸ¥ QStash Dashboard ä¸­çš„ä»»åŠ¡çŠ¶æ€
4. éªŒè¯ Worker è·¯ç”±æ˜¯å¦è¢«è°ƒç”¨
5. æ£€æŸ¥æ•°æ®åº“ä¸­çš„ä»»åŠ¡çŠ¶æ€æ›´æ–°

**é¢„æœŸç»“æœ**:
- âœ… Submit è·¯ç”±è¿”å› 202 Accepted
- âœ… QStash æˆåŠŸæ¥æ”¶ä»»åŠ¡
- âœ… Worker è·¯ç”±è¢«è°ƒç”¨
- âœ… ä»»åŠ¡çŠ¶æ€æ­£ç¡®æ›´æ–°

---

### Phase 2: åŠŸèƒ½éªŒè¯æµ‹è¯•

**æµ‹è¯•é¡¹**:
- [ ] 4ç§’ç†”æ–­æœºåˆ¶ï¼ˆæ¨¡æ‹Ÿæ…¢é€Ÿè®¤è¯ï¼‰
- [ ] å¹‚ç­‰æ€§æ£€æŸ¥ï¼ˆé‡å¤è°ƒç”¨ Workerï¼‰
- [ ] çŠ¶æ€ç»†åŒ–ï¼ˆdownloading â†’ processing â†’ extractedï¼‰
- [ ] æµå¼å¤„ç†ï¼ˆå¤§æ–‡ä»¶è§†é¢‘ï¼‰
- [ ] é”™è¯¯å¤„ç†å’Œå›æ»š

---

### Phase 3: æ€§èƒ½æµ‹è¯•

**æµ‹è¯•é¡¹**:
- [ ] 50MB è§†é¢‘å¤„ç†ï¼ˆç›‘æ§å†…å­˜å³°å€¼ï¼‰
- [ ] 3åˆ†é’Ÿä»¥ä¸Šè§†é¢‘å¤„ç†
- [ ] å¹¶å‘ä»»åŠ¡å¤„ç†
- [ ] QStash é‡è¯•æœºåˆ¶

---

## ğŸ“Š æ¶æ„æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ POST /api/media/submit
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /api/media/submit                  â”‚
â”‚  - 4ç§’ç†”æ–­: getUserInfo()           â”‚
â”‚  - åˆ›å»ºä»»åŠ¡ (status: pending)      â”‚
â”‚  - æ¨é€ QStash                      â”‚
â”‚  - è¿”å› 202 + taskId                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 202 Accepted
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend  â”‚
â”‚  - æ˜¾ç¤º"å¤„ç†ä¸­"                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ QStash å¼‚æ­¥è°ƒç”¨
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /api/media/worker                  â”‚
â”‚  - éªŒè¯ QStash ç­¾å                 â”‚
â”‚  - å¹‚ç­‰æ€§æ£€æŸ¥                       â”‚
â”‚  - çŠ¶æ€: downloading                â”‚
â”‚  - è°ƒç”¨ RapidAPI (æµå¼)            â”‚
â”‚  - çŠ¶æ€: processing                  â”‚
â”‚  - æµå¼ä¸Šä¼  Vercel Blob             â”‚
â”‚  - çŠ¶æ€: extracted                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ çŠ¶æ€æ›´æ–°
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase Database                  â”‚
â”‚  - media_tasks è¡¨æ›´æ–°               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. QStash ç­¾åéªŒè¯

å¦‚æœé‡åˆ° `401 Unauthorized` é”™è¯¯ï¼Œæ£€æŸ¥ï¼š
- âœ… QSTASH_CURRENT_SIGNING_KEY æ˜¯å¦æ­£ç¡®
- âœ… QSTASH_NEXT_SIGNING_KEY æ˜¯å¦é…ç½®ï¼ˆç”¨äºå¯†é’¥è½®æ¢ï¼‰
- âœ… Body è§£æé¡ºåºï¼ˆå…ˆéªŒè¯ç­¾åï¼Œå†è§£æ bodyï¼‰

### 2. Vercel è¶…æ—¶é…ç½®

- âœ… Worker è·¯ç”±å·²é…ç½® 300 ç§’è¶…æ—¶
- âœ… éœ€è¦ Vercel Pro è®¡åˆ’æ”¯æŒ
- âœ… å…è´¹ç‰ˆæœ€å¤§æ”¯æŒ 10 ç§’

### 3. å¹‚ç­‰æ€§ä¿è¯

- âœ… Worker è·¯ç”±åŒ…å«å¹‚ç­‰æ€§æ£€æŸ¥
- âœ… å·²å®Œæˆçš„ä»»åŠ¡ä¸ä¼šé‡å¤å¤„ç†
- âœ… æ­£åœ¨å¤„ç†çš„ä»»åŠ¡åœ¨ 10 åˆ†é’Ÿå†…ä¸ä¼šé‡å¤å¤„ç†

### 4. å‘åå…¼å®¹

- âœ… å¦‚æœ QStash æœªé…ç½®ï¼Œè‡ªåŠ¨ fallback åˆ°ç›´æ¥å¤„ç†
- âœ… ä¿æŒåŸæœ‰ `processMediaTask` å‡½æ•°ä½œä¸ºå¤‡ç”¨

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ

1. **é…ç½®ç¯å¢ƒå˜é‡**
   - åœ¨ Vercel Dashboard ä¸­é…ç½® QStash Token
   - é…ç½® Signing Keys

2. **æµ‹è¯•åŸºç¡€æ¡æ‰‹**
   - æäº¤ä¸€ä¸ªæµ‹è¯•ä»»åŠ¡
   - éªŒè¯ QStash Dashboard
   - æ£€æŸ¥ Worker æ—¥å¿—

3. **ç›‘æ§å’Œä¼˜åŒ–**
   - ç›‘æ§å†…å­˜ä½¿ç”¨
   - æ£€æŸ¥å¤„ç†æ—¶é—´
   - ä¼˜åŒ–é”™è¯¯å¤„ç†

---

## ğŸ“ ä»£ç å˜æ›´æ¸…å•

### æ–°å¢æ–‡ä»¶
- âœ… `src/app/api/media/worker/route.ts` - Worker è·¯ç”±

### ä¿®æ”¹æ–‡ä»¶
- âœ… `src/app/api/media/submit/route.ts` - æ·»åŠ ç†”æ–­å’Œ QStash
- âœ… `src/shared/models/media_task.ts` - æ›´æ–°çŠ¶æ€ç±»å‹
- âœ… `vercel.json` - é…ç½® Worker è¶…æ—¶

### ä¾èµ–å˜æ›´
- âœ… `@upstash/qstash` - æ–°å¢ä¾èµ–

---

## âœ… å®æ–½æ£€æŸ¥æ¸…å•

- [x] å®‰è£… QStash ä¾èµ–
- [x] åˆ›å»º Worker è·¯ç”±
- [x] ä¿®æ”¹ Submit è·¯ç”±
- [x] æ›´æ–°çŠ¶æ€ç±»å‹å®šä¹‰
- [x] é…ç½® Vercel è¶…æ—¶
- [ ] é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¾…ç”¨æˆ·é…ç½®ï¼‰
- [ ] æµ‹è¯•åŸºç¡€æ¡æ‰‹ï¼ˆå¾…æµ‹è¯•ï¼‰
- [ ] åŠŸèƒ½éªŒè¯æµ‹è¯•ï¼ˆå¾…æµ‹è¯•ï¼‰
- [ ] æ€§èƒ½æµ‹è¯•ï¼ˆå¾…æµ‹è¯•ï¼‰

---

**å®æ–½å®Œæˆæ—¶é—´**: 2024-12-25  
**çŠ¶æ€**: âœ… ä»£ç å®æ–½å®Œæˆï¼Œç­‰å¾…ç¯å¢ƒé…ç½®å’Œæµ‹è¯•éªŒè¯
