# è§†é¢‘ä¸‹è½½ Phase 2 å®æ–½å®ŒæˆæŠ¥å‘Š

## âœ… å®æ–½çŠ¶æ€

**å·²å®Œæˆ**ï¼šPhase 2 æ ¸å¿ƒä¼˜åŒ–å·²å®æ–½ï¼ŒYouTube è§†é¢‘ä¹Ÿå°è¯•ä¸Šä¼ åˆ° Vercel Blobï¼Œä½¿ç”¨å¼‚æ­¥ä¸Šä¼ ä¸é˜»å¡ Workerã€‚

---

## ğŸ“‹ å®æ–½å†…å®¹

### 1. ä¼˜åŒ– Worker é€»è¾‘ï¼ˆå¼‚æ­¥ä¸Šä¼ ç­–ç•¥ï¼‰

**æ–‡ä»¶**: `src/app/api/media/worker/route.ts`

**æ ¸å¿ƒæ”¹è¿›**ï¼š
- âœ… **YouTube è§†é¢‘ä¹Ÿå°è¯•ä¸Šä¼ **ï¼šä¸å†åªå¯¹ TikTok è§†é¢‘ä¸Šä¼ ï¼ŒYouTube è§†é¢‘ä¹Ÿå°è¯•ä¸Šä¼ åˆ° Vercel Blob
- âœ… **å¼‚æ­¥ä¸Šä¼ **ï¼šä½¿ç”¨ `(async () => { ... })()` æ¨¡å¼ï¼Œä¸ awaitï¼Œä¸é˜»å¡ Worker
- âœ… **Worker å¿«é€Ÿè¿”å›**ï¼šWorker åœ¨ 10 ç§’å†…å®Œæˆï¼Œä¸Šä¼ åœ¨åå°è¿›è¡Œ
- âœ… **çŠ¶æ€å®æ—¶æ›´æ–°**ï¼šé€šè¿‡ Supabase Realtime å®æ—¶æ›´æ–°ä¸Šä¼ è¿›åº¦

**å…³é”®ä»£ç **:
```typescript
// å¼‚æ­¥ä¸Šä¼ åˆ° Vercel Blobï¼ˆä¸ awaitï¼Œä¸é˜»å¡ Workerï¼‰
if (process.env.BLOB_READ_WRITE_TOKEN) {
  (async () => {
    try {
      console.log(`[Worker] ğŸ“¤ [Upload] Starting async upload for ${mediaData.platform} video...`);
      const storageIdentifier = await uploadVideoToStorage(mediaData.videoUrl);

      if (storageIdentifier) {
        // ä¸Šä¼ æˆåŠŸï¼šä½¿ç”¨ Vercel Blob URLï¼ˆæ°¸ä¹…æœ‰æ•ˆï¼‰
        const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24 hours
        await updateMediaTaskById(taskId, {
          videoUrlInternal: storageIdentifier,
          expiresAt,
          progress: 100,
          status: 'extracted',
        });
        console.log(`[Worker] âœ… [Upload] Video uploaded to Vercel Blob successfully`);
      } else {
        // ä¸Šä¼ å¤±è´¥ï¼šä½¿ç”¨åŸå§‹ URLï¼ˆ2å°æ—¶è¿‡æœŸï¼‰
        const expiresAt = new Date(Date.now() + 2 * 60 * 60 * 1000); // 2 hours
        await updateMediaTaskById(taskId, {
          videoUrlInternal: `original:${mediaData.videoUrl}`,
          expiresAt,
          progress: 100,
          status: 'extracted',
        });
        console.log(`[Worker] âš ï¸ [Upload] Upload failed, using original URL`);
      }
    } catch (uploadError: any) {
      // ä¸Šä¼ å‡ºé”™ï¼šä½¿ç”¨åŸå§‹ URLï¼ˆ2å°æ—¶è¿‡æœŸï¼‰
      console.error(`[Worker] âŒ [Upload] Upload error:`, uploadError.message);
      const expiresAt = new Date(Date.now() + 2 * 60 * 60 * 1000); // 2 hours
      await updateMediaTaskById(taskId, {
        videoUrlInternal: `original:${mediaData.videoUrl}`,
        expiresAt,
        progress: 100,
        status: 'extracted',
      });
    }
  })();
}
```

### 2. çŠ¶æ€ç®¡ç†ä¼˜åŒ–

**æ”¹è¿›**ï¼š
- âœ… **ç«‹å³ä¿å­˜åŸå§‹ URL**ï¼šWorker ç«‹å³ä¿å­˜ `videoUrl` åˆ°æ•°æ®åº“ï¼Œä¾›ä¸‹è½½ä½¿ç”¨
- âœ… **çŠ¶æ€æ›´æ–°**ï¼šä¸Šä¼ å¼€å§‹æ—¶ï¼ŒçŠ¶æ€æ›´æ–°ä¸º `downloading`
- âœ… **è¿›åº¦æ›´æ–°**ï¼šä¸Šä¼ å®Œæˆåï¼Œè¿›åº¦æ›´æ–°ä¸º 100%ï¼ŒçŠ¶æ€æ›´æ–°ä¸º `extracted`
- âœ… **å®æ—¶é€šçŸ¥**ï¼šé€šè¿‡ Supabase Realtime å®æ—¶é€šçŸ¥å‰ç«¯

**å…³é”®ä»£ç **:
```typescript
// ç«‹å³æ›´æ–°æ•°æ®åº“ï¼Œä¸ç­‰å¾…ä¸Šä¼ 
await updateMediaTaskById(taskId, {
  status: 'downloading', // æ›´æ–°çŠ¶æ€ä¸º downloadingï¼ˆè¡¨ç¤ºæ­£åœ¨ä¸Šä¼ ï¼‰
  progress: 40,
  videoUrl: mediaData.videoUrl, // å…ˆä¿å­˜åŸå§‹ URLï¼Œä¾›ä¸‹è½½ä½¿ç”¨
});
```

### 3. ç¼“å­˜å‘½ä¸­ä¼˜åŒ–

**æ”¹è¿›**ï¼š
- âœ… **ç¼“å­˜å‘½ä¸­ä¹Ÿä½¿ç”¨å¼‚æ­¥ä¸Šä¼ **ï¼šå¦‚æœé…ç½®äº† Vercel Blobï¼Œç¼“å­˜å‘½ä¸­çš„è§†é¢‘ä¹Ÿå°è¯•ä¸Šä¼ 
- âœ… **ç»Ÿä¸€çš„ä¸Šä¼ ç­–ç•¥**ï¼šç¼“å­˜å‘½ä¸­å’Œæ–°ä»»åŠ¡ä½¿ç”¨ç›¸åŒçš„å¼‚æ­¥ä¸Šä¼ é€»è¾‘

**å…³é”®ä»£ç **:
```typescript
// å¯¹äºç¼“å­˜å‘½ä¸­ï¼Œä¹Ÿä½¿ç”¨å¼‚æ­¥ä¸Šä¼ ç­–ç•¥ï¼ˆå¦‚æœé…ç½®äº† Vercel Blobï¼‰
if (process.env.BLOB_READ_WRITE_TOKEN) {
  // å¼‚æ­¥ä¸Šä¼ ï¼ˆä¸ awaitï¼Œä¸é˜»å¡ï¼‰
  (async () => {
    try {
      const storageIdentifier = await uploadVideoToStorage(cached.downloadUrl);
      // ... ä¸Šä¼ é€»è¾‘
    } catch (error) {
      // ... é”™è¯¯å¤„ç†
    }
  })();
  
  // å…ˆä½¿ç”¨åŸå§‹ URLï¼Œä¸Šä¼ å®Œæˆåä¼šæ›´æ–°
  videoUrlInternal = `original:${cached.downloadUrl}`;
  expiresAt = new Date(Date.now() + 2 * 60 * 60 * 1000);
  await updateMediaTaskById(taskId, { 
    progress: 70,
    status: 'downloading', // ä¸Šä¼ è¿›è¡Œä¸­
  });
}
```

---

## ğŸ¯ å…³é”®ç‰¹æ€§

### 1. å¼‚æ­¥ä¸Šä¼ ç­–ç•¥

**ä¼˜ç‚¹**ï¼š
- âœ… Worker å¿«é€Ÿè¿”å›ï¼ˆ< 10ç§’ï¼‰ï¼Œä¸è¶…æ—¶
- âœ… æ”¯æŒé•¿æ—¶é—´ä¸Šä¼ ï¼ˆ3-5 åˆ†é’Ÿï¼‰
- âœ… ä¸é˜»å¡å…¶ä»–ä»»åŠ¡å¤„ç†
- âœ… é€šè¿‡ Supabase Realtime å®æ—¶æ›´æ–°çŠ¶æ€

**æµç¨‹**ï¼š
```
1. Worker è·å–è§†é¢‘ URLï¼ˆå¿«é€Ÿï¼Œ< 10ç§’ï¼‰
   â†“
2. ç«‹å³æ›´æ–°æ•°æ®åº“ï¼šstatus = 'downloading', videoUrl = '...'
   â†“
3. å¯åŠ¨å¼‚æ­¥ä¸Šä¼ ä»»åŠ¡ï¼ˆä¸ awaitï¼‰
   â†“
4. Worker ç«‹å³è¿”å›æˆåŠŸ
   â†“
5. ä¸Šä¼ åœ¨åå°è¿›è¡Œï¼ˆ3-5 åˆ†é’Ÿï¼‰
   â†“
6. ä¸Šä¼ å®Œæˆåæ›´æ–°ï¼švideoUrlInternal = 'vercel-blob:...', status = 'extracted'
   â†“
7. å‰ç«¯é€šè¿‡ Supabase Realtime å®æ—¶çœ‹åˆ°çŠ¶æ€å˜åŒ–
```

### 2. ç»Ÿä¸€çš„ä¸Šä¼ ç­–ç•¥

**æ”¹è¿›**ï¼š
- âœ… TikTok å’Œ YouTube è§†é¢‘éƒ½å°è¯•ä¸Šä¼ 
- âœ… ç¼“å­˜å‘½ä¸­å’Œæ–°ä»»åŠ¡ä½¿ç”¨ç›¸åŒçš„ä¸Šä¼ é€»è¾‘
- âœ… å¦‚æœä¸Šä¼ å¤±è´¥ï¼Œè‡ªåŠ¨å›é€€åˆ°åŸå§‹ URL

### 3. é”™è¯¯å¤„ç†

**æ”¹è¿›**ï¼š
- âœ… ä¸Šä¼ å¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°åŸå§‹ URL
- âœ… è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- âœ… ç¡®ä¿ä»»åŠ¡çŠ¶æ€æ­£ç¡®æ›´æ–°

---

## ğŸ“Š ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

1. âœ… `src/app/api/media/worker/route.ts`
   - ä¼˜åŒ–è§†é¢‘ä¸Šä¼ é€»è¾‘ï¼ˆå¼‚æ­¥ä¸Šä¼ ï¼‰
   - YouTube è§†é¢‘ä¹Ÿå°è¯•ä¸Šä¼ åˆ° Vercel Blob
   - ç¼“å­˜å‘½ä¸­ä¹Ÿä½¿ç”¨å¼‚æ­¥ä¸Šä¼ 
   - çŠ¶æ€ç®¡ç†ä¼˜åŒ–

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•æ­¥éª¤**ï¼š
1. æäº¤ YouTube URLï¼Œé€‰æ‹© "Download Video"
2. éªŒè¯ Worker å¿«é€Ÿè¿”å›ï¼ˆ< 10ç§’ï¼‰
3. éªŒè¯æ•°æ®åº“çŠ¶æ€æ›´æ–°ä¸º `downloading`
4. éªŒè¯ `videoUrl` å­—æ®µå·²ä¿å­˜
5. ç­‰å¾… 3-5 åˆ†é’Ÿï¼ŒéªŒè¯ä¸Šä¼ å®Œæˆ
6. éªŒè¯ `videoUrlInternal` æ›´æ–°ä¸º `vercel-blob:...`
7. éªŒè¯çŠ¶æ€æ›´æ–°ä¸º `extracted`

### 2. å®æ—¶æ›´æ–°æµ‹è¯•

**æµ‹è¯•æ­¥éª¤**ï¼š
1. æ‰“å¼€å‰ç«¯é¡µé¢
2. æäº¤è§†é¢‘ä¸‹è½½ä»»åŠ¡
3. éªŒè¯å‰ç«¯å®æ—¶çœ‹åˆ°çŠ¶æ€å˜åŒ–ï¼š
   - `processing` â†’ `downloading` â†’ `extracted`
4. éªŒè¯è¿›åº¦æ¡å®æ—¶æ›´æ–°

### 3. é”™è¯¯åœºæ™¯æµ‹è¯•

**æµ‹è¯•å†…å®¹**ï¼š
- æµ‹è¯• Vercel Blob æœªé…ç½®çš„æƒ…å†µï¼ˆåº”ä½¿ç”¨åŸå§‹ URLï¼‰
- æµ‹è¯•ä¸Šä¼ å¤±è´¥çš„æƒ…å†µï¼ˆåº”å›é€€åˆ°åŸå§‹ URLï¼‰
- æµ‹è¯•ç½‘ç»œé”™è¯¯çš„æƒ…å†µï¼ˆåº”å›é€€åˆ°åŸå§‹ URLï¼‰

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒå˜é‡**ï¼š
   - ç¡®ä¿ `BLOB_READ_WRITE_TOKEN` å·²é…ç½®ï¼ˆå¦‚æœä½¿ç”¨ Vercel Blobï¼‰
   - å¦‚æœæ²¡æœ‰é…ç½®ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨åŸå§‹ URL

2. **æˆæœ¬è€ƒè™‘**ï¼š
   - Vercel Blob å­˜å‚¨æœ‰æˆæœ¬
   - è§†é¢‘æ–‡ä»¶è¾ƒå¤§ï¼Œä¸Šä¼ ä¼šæ¶ˆè€—å¸¦å®½
   - å»ºè®®è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼ˆ24å°æ—¶ï¼‰

3. **æ€§èƒ½è€ƒè™‘**ï¼š
   - Worker å¿…é¡»å¿«é€Ÿè¿”å›ï¼ˆ< 10ç§’ï¼‰
   - ä¸Šä¼ åœ¨åå°è¿›è¡Œï¼Œä¸é˜»å¡ Worker
   - é€šè¿‡ Supabase Realtime å®æ—¶æ›´æ–°çŠ¶æ€

---

## âœ… æ€»ç»“

Phase 2 å·²å…¨éƒ¨å®Œæˆï¼š

1. âœ… **YouTube è§†é¢‘ä¹Ÿå°è¯•ä¸Šä¼ **ï¼šä¸å†åªå¯¹ TikTok è§†é¢‘ä¸Šä¼ 
2. âœ… **å¼‚æ­¥ä¸Šä¼ ç­–ç•¥**ï¼šWorker å¿«é€Ÿè¿”å›ï¼Œä¸Šä¼ åœ¨åå°è¿›è¡Œ
3. âœ… **çŠ¶æ€å®æ—¶æ›´æ–°**ï¼šé€šè¿‡ Supabase Realtime å®æ—¶é€šçŸ¥å‰ç«¯
4. âœ… **ç»Ÿä¸€çš„ä¸Šä¼ ç­–ç•¥**ï¼šç¼“å­˜å‘½ä¸­å’Œæ–°ä»»åŠ¡ä½¿ç”¨ç›¸åŒçš„é€»è¾‘
5. âœ… **å®Œå–„çš„é”™è¯¯å¤„ç†**ï¼šä¸Šä¼ å¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°åŸå§‹ URL

æ‰€æœ‰ä»£ç å·²é€šè¿‡è¯­æ³•æ£€æŸ¥ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•ã€‚

---

## ğŸ“ ä¸‹ä¸€æ­¥

Phase 1 å’Œ Phase 2 éƒ½å·²å®Œæˆï¼Œå»ºè®®ï¼š

1. **æµ‹è¯•åŠŸèƒ½**ï¼š
   - æµ‹è¯• YouTube è§†é¢‘ä¸‹è½½
   - æµ‹è¯• TikTok è§†é¢‘ä¸‹è½½
   - éªŒè¯å¼‚æ­¥ä¸Šä¼ åŠŸèƒ½

2. **ç›‘æ§æ€§èƒ½**ï¼š
   - ç›‘æ§ Worker æ‰§è¡Œæ—¶é—´
   - ç›‘æ§ä¸Šä¼ æˆåŠŸç‡
   - ç›‘æ§å­˜å‚¨æˆæœ¬

3. **ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰**ï¼š
   - æ·»åŠ ä¸Šä¼ è¿›åº¦æ˜¾ç¤º
   - ä¼˜åŒ–é”™è¯¯é‡è¯•é€»è¾‘
   - æ·»åŠ ä¸Šä¼ é˜Ÿåˆ—ç®¡ç†
